import secrets, sqlite3, time, os
from datetime import datetime, timedelta

DB_PATH = os.path.join(os.path.dirname(__file__), "..", "sessions.db")

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS sessions (
        email TEXT, token TEXT, expires_at REAL
    )""")
    conn.commit(); conn.close()

def create_magic_link(email: str) -> str:
    token = secrets.token_urlsafe(24)
    expires_at = time.time() + 900
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO sessions VALUES (?, ?, ?)", (email, token, expires_at))
    conn.commit(); conn.close()
    return f"https://the13th.onrender.com/client/login?token={token}"

def validate_token(token: str):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT email, expires_at FROM sessions WHERE token=?", (token,))
    row = c.fetchone()
    conn.close()
    if not row: return None
    email, exp = row
    if time.time() > exp: return None
    return email

import requests

def notify_webhook(status: str, recipient: str, message: str = ""):
    url = os.getenv("WEBHOOK_URL")
    if not url: return
    payload = {"content": f"ðŸ“¡ **THE13TH Email {status.upper()}** â†’ {recipient}\n{message}"}
    try:
        requests.post(url, json=payload, timeout=10)
    except Exception as e:
        print(f"âš ï¸ Webhook notification failed: {e}")

def log_email_delivery(recipient: str, status: str, message: str = ""):
    log_dir = os.path.join(os.path.dirname(__file__), "..", "logs")
    os.makedirs(log_dir, exist_ok=True)
    log_path = os.path.join(log_dir, "email_delivery.log")
    timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
    line = f"[{timestamp}] {status.upper()} â€” {recipient} â€” {message}\n"
    with open(log_path, "a") as f:
        f.write(line)
    notify_webhook(status, recipient, message)

# === Admin Auth Dependency ===
from fastapi import Request, HTTPException

def auth_admin(request: Request):
    session_token = request.cookies.get("session_token")
    if not session_token:
        raise HTTPException(status_code=401, detail="Unauthorized")
    try:
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        c.execute("SELECT role FROM sessions WHERE token=?", (session_token,))
        row = c.fetchone()
        conn.close()
        if not row or row[0] != "admin":
            raise HTTPException(status_code=401, detail="Unauthorized")
    except:
        raise HTTPException(status_code=401, detail="Unauthorized")
    return session_token

# === âœ… Updated Admin Login Credentials ===
ADMIN_EMAIL = "admin@the13th.com"
ADMIN_PASSWORD = "The13th@2025"

def verify_admin_credentials(email: str, password: str) -> bool:
    return email.lower() == ADMIN_EMAIL.lower() and password == ADMIN_PASSWORD

def create_admin_session():
    token = secrets.token_urlsafe(32)
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
        CREATE TABLE IF NOT EXISTS sessions (
            token TEXT PRIMARY KEY,
            email TEXT,
            role TEXT,
            created_at TEXT,
            expires_at TEXT
        )
    """)
    now = datetime.utcnow()
    expiry = now + timedelta(hours=6)
    c.execute(
        "INSERT OR REPLACE INTO sessions (token, email, role, created_at, expires_at) VALUES (?, ?, ?, ?, ?)",
        (token, ADMIN_EMAIL, "admin", now.isoformat(), expiry.isoformat())
    )
    conn.commit()
    conn.close()
    return token
